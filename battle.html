<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bitcoin Melee — Battle</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h2 { margin-top: 1rem; }
    ul { list-style: none; padding: 0; }
    li { margin: 0.2rem 0; }
    #startBattle { padding: 0.5rem 1rem; font-size: 1rem; margin-top: 1rem; }
    #battleLog { max-height: 400px; overflow-y: auto; margin-top: 1rem; border: 1px solid #ccc; padding: 0.5rem; }
    .hidden { display: none; }
    /* player controls */
    #controls { margin-top: 1rem; border: 1px solid #999; padding: 0.5rem; background: #fafafa; }
    #controls p { margin: 0.2rem 0 0.4rem; }
    .charCtrl { margin: 0.2rem 0; }
    .charCtrl button { margin-left: 0.4rem; }
    .ap { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Battle Arena</h1>

  <div id="teams">
    <h2>Your Team</h2>
    <ul id="userTeam"></ul>
    <h2>Enemy Team</h2>
    <ul id="enemyTeam"></ul>
  </div>

  <button id="startBattle" disabled>Start Battle</button>
  <div id="battleLog"></div>

  <!-- Player action controls -->
  <div id="controls" class="hidden"></div>

<script>
/***** Helper Functions *****/
const cap = s => (typeof s === 'string' && s.length) ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
const d20 = () => Math.floor(Math.random() * 20) + 1;
const d6  = () => Math.floor(Math.random() * 6) + 1;
const mod = v => Math.floor((v - 10) / 2);

/***** Load JSON *****/
let characters = [], abilities = {};
Promise.all([
  fetch('characters.json').then(r => r.json()),
  fetch('abilities.json').then(r => r.json())
]).then(([c, a]) => {
  characters = c; abilities = a; initTeams();
  document.getElementById('startBattle').disabled = false; // enable once data loaded
}).catch(err => console.error('Failed to load data', err));

let userTeamData = [], enemyTeamData = [];
function initTeams() {
  const stored = sessionStorage.getItem('roster');
  if (!stored) { console.error('No roster found'); return; }
  userTeamData = JSON.parse(stored);

  const used = new Set(userTeamData.map(h => h.Name));
  const pool = characters.filter(c => !used.has(c.Name));
  shuffle(pool);
  enemyTeamData = pool.slice(0, userTeamData.length);

  renderInitialTeams();
}
function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }

/***** Character Class *****/
class Character {
  constructor(name, hp, str, con, dex, ability) {
    this.name = name; this.maxHp = hp; this.hp = hp;
    this.str = str; this.con = con; this.dex = dex; this.ability = ability;
  }
  isAlive() { return this.hp > 0; }
  applyAbility(allies, foes, target) {
    const eff = abilities[this.ability] || {};
    for (const [k, v] of Object.entries(eff)) {
      const stat = k.split('_')[0];
      if (k.endsWith('_Self')) this._applyStat(stat, v);
      if (k.endsWith('_ally')) allies.forEach(a => a._applyStat(stat, v));
      if (k.endsWith('_Foe') && target) target._applyStat(stat, v);
    }
  }
  _applyStat(stat, val) {
    if (stat === 'Health') this.hp = Math.min(this.maxHp, Math.max(0, this.hp + val));
    if (stat === 'Strength') this.str = Math.max(0, this.str + val);
    if (stat === 'Constitution') this.con = Math.max(0, this.con + val);
    if (stat === 'Dexterity') this.dex = Math.max(0, this.dex + val);
  }
  attack(t) {
    const atk = d20() + mod(this.str);
    const ac  = 10 + mod(t.dex);
    if (atk < ac) return { hit: false, dmg: 0 };
    const dmg = Math.max(1, d6() + mod(this.str));
    t.hp = Math.max(0, t.hp - dmg);
    return { hit: true, dmg };
  }
}
const inst = d => d.map(c => new Character(c.Name, c.Health, c.Strength, c.Constitution, c.Dexterity, c['Common Ability'] || ''));

/***** Battle State *****/
let playerChars = [], enemyChars = [];
let playerAP = 0, aiAP = 0;
let playerTurn = true; // true = player's turn, false = AI turn

/***** UI Helpers *****/
const logDiv = document.getElementById('battleLog');
function log(msg) {
  const p = document.createElement('p'); p.textContent = msg; logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;
}
function renderInitialTeams() {
  // populate initial static lists before battle starts
  const ulU = document.getElementById('userTeam');
  userTeamData.forEach(h => { const li = document.createElement('li'); li.textContent = cap(h.Name); ulU.appendChild(li); });

  const ulE = document.getElementById('enemyTeam');
  enemyTeamData.forEach(h => { const li = document.createElement('li'); li.textContent = cap(h.Name); ulE.appendChild(li); });
}
function refreshTeamLists() {
  const ulU = document.getElementById('userTeam');
  ulU.innerHTML = '';
  playerChars.forEach(c => {
    const li = document.createElement('li');
    li.textContent = `${cap(c.name)} (${c.hp}/${c.maxHp})${!c.isAlive() ? ' ✝' : ''}`;
    ulU.appendChild(li);
  });
  const ulE = document.getElementById('enemyTeam');
  ulE.innerHTML = '';
  enemyChars.forEach(c => {
    const li = document.createElement('li');
    li.textContent = `${cap(c.name)} (${c.hp}/${c.maxHp})${!c.isAlive() ? ' ✝' : ''}`;
    ulE.appendChild(li);
  });
}

/***** Battle Flow *****/
function startBattle() {
  document.getElementById('startBattle').disabled = true;
  logDiv.innerHTML = '';
  playerChars = inst(userTeamData);
  enemyChars  = inst(enemyTeamData);
  refreshTeamLists();
  playerTurn = true;
  startPlayerTurn();
}

/******* Player Turn ******/
function startPlayerTurn() {
  if (checkVictory()) return;
  playerAP = 5;
  renderPlayerControls();
}
function renderPlayerControls() {
  const ctrl = document.getElementById('controls');
  ctrl.innerHTML = '';
  ctrl.classList.remove('hidden');

  const header = document.createElement('p');
  header.innerHTML = `Your turn — <span class="ap">${playerAP}</span> Action Points left`;
  ctrl.appendChild(header);

  playerChars.filter(c => c.isAlive()).forEach((c) => {
    const row = document.createElement('div');
    row.className = 'charCtrl';
    const label = document.createElement('span');
    label.textContent = cap(c.name);
    row.appendChild(label);

    const atkBtn = document.createElement('button');
    atkBtn.textContent = 'Attack';
    atkBtn.addEventListener('click', () => chooseTarget(c, 'attack'));
    row.appendChild(atkBtn);

    if (c.ability) {
      const abBtn = document.createElement('button');
      abBtn.textContent = cap(c.ability);
      abBtn.addEventListener('click', () => chooseTarget(c, 'ability'));
      row.appendChild(abBtn);
    }
    ctrl.appendChild(row);
  });
}
function chooseTarget(char, action) {
  const ctrl = document.getElementById('controls');
  ctrl.innerHTML = '';
  const prompt = document.createElement('p');
  prompt.textContent = `Choose target for ${cap(char.name)}ʼs ${action === 'attack' ? 'attack' : cap(char.ability)}:`;
  ctrl.appendChild(prompt);

  const targets = action === 'attack'
    ? enemyChars.filter(c => c.isAlive())
    : [...playerChars.filter(c => c.isAlive()), ...enemyChars.filter(c => c.isAlive())];

  targets.forEach(t => {
    const btn = document.createElement('button');
    btn.textContent = `${cap(t.name)} (${t.hp}/${t.maxHp})`;
    btn.addEventListener('click', () => performPlayerAction(char, action, t));
    ctrl.appendChild(btn);
  });

  const back = document.createElement('button');
  back.textContent = 'Back';
  back.style.marginLeft = '0.5rem';
  back.addEventListener('click', renderPlayerControls);
  ctrl.appendChild(back);
}
function performPlayerAction(char, action, target) {
  if (!char.isAlive()) { renderPlayerControls(); return; }
  if (action === 'attack') {
    const { hit, dmg } = char.attack(target);
    log(hit ? `${cap(char.name)} hits ${cap(target.name)} for ${dmg} dmg (${target.hp}/${target.maxHp})`
            : `${cap(char.name)} misses ${cap(target.name)}`);
  } else {
    log(`${cap(char.name)} uses ${cap(char.ability)} on ${cap(target.name)}`);
    char.applyAbility(playerChars, enemyChars, target);
  }
  refreshTeamLists();
  playerAP--;
  if (checkVictory()) return;
  if (playerAP > 0) {
    renderPlayerControls();
  } else {
    endPlayerTurn();
  }
}
function endPlayerTurn() {
  document.getElementById('controls').classList.add('hidden');
  playerTurn = false;
  setTimeout(startAiTurn, 600);
}

/******* AI Turn ******/
function startAiTurn() {
  if (checkVictory()) return;
  aiAP = 5;
  log('-- Enemy Turn --');
  aiStep();
}
function aiStep() {
  if (aiAP === 0) {
    playerTurn = true;
    setTimeout(startPlayerTurn, 600);
    return;
  }
  const livingAI = enemyChars.filter(c => c.isAlive());
  if (!livingAI.length) { checkVictory(); return; }
  const actor = livingAI[Math.floor(Math.random() * livingAI.length)];
  const useAbility = (Math.random() < 0.25) && actor.ability;
  const action = useAbility ? 'ability' : 'attack';

  let target;
  if (action === 'attack') {
    const foes = playerChars.filter(c => c.isAlive());
    target = foes[Math.floor(Math.random() * foes.length)];
    const { hit, dmg } = actor.attack(target);
    log(hit ? `${cap(actor.name)} hits ${cap(target.name)} for ${dmg} dmg (${target.hp}/${target.maxHp})`
            : `${cap(actor.name)} misses ${cap(target.name)}`);
  } else {
    const candidates = [...playerChars.filter(c => c.isAlive()), ...enemyChars.filter(c => c.isAlive())];
    target = candidates[Math.floor(Math.random() * candidates.length)];
    log(`${cap(actor.name)} uses ${cap(actor.ability)} on ${cap(target.name)}`);
    actor.applyAbility(enemyChars, playerChars, target);
  }
  refreshTeamLists();
  aiAP--;
  if (checkVictory()) return;
  setTimeout(aiStep, 600);
}

/***** Victory Check *****/
function checkVictory() {
  const youAlive = playerChars.some(c => c.isAlive());
  const enemyAlive = enemyChars.some(c => c.isAlive());
  if (youAlive && enemyAlive) return false;
  const youCount = playerChars.filter(c => c.isAlive()).length;
  const enemyCount = enemyChars.filter(c => c.isAlive()).length;
  log(youCount > enemyCount ? `You win! (${youCount} vs ${enemyCount})` : enemyCount > youCount ? `Enemy wins! (${enemyCount} vs ${youCount})` : 'Tie!');
  document.getElementById('startBattle').disabled = false;
  return true;
}

/***** Event Listener *****/
document.getElementById('startBattle').addEventListener('click', startBattle);
</script>
</body>
</html>