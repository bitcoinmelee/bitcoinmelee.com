<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bitcoin Melee — Draft</title>

  <!-- fantasy & body fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Lora:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root{--border:#8c6b42;--card:#fff8ef;--accent:#d1b280;--ink:#2b2a29}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Lora',serif;background:#f9f4e8;color:var(--ink);padding:1rem;}
    h1{font-family:'Cinzel',serif;margin:0 0 1rem;text-align:center;font-size:2rem;letter-spacing:0.5px;}
    h2{font-family:'Cinzel',serif;margin:0;text-align:center;font-size:1.15rem}
    #boards{display:flex;gap:1rem;flex-wrap:wrap}
    .panel{flex:1 1 330px;border:3px double var(--border);background:var(--card);padding:0.6rem;border-radius:8px;min-height:310px}
    .list{display:flex;flex-direction:column;gap:0.4rem;min-height:250px}
    .picked{opacity:0.6;cursor:default}
    #log{margin-top:0.9rem;height:95px;overflow:auto;border:2px solid var(--border);padding:0.5rem;background:#fffefa;font-size:0.9rem}
    #ready{display:block;margin:1rem auto 0;padding:0.6rem 1.5rem;font-family:'Cinzel',serif;font-size:1.05rem;background:var(--accent);border:2px solid var(--border);border-radius:7px;cursor:pointer}
    #ready.hidden{display:none}

    /* tooltip */
    .tooltip{position:fixed;max-width:280px;z-index:999;background:var(--card);border:2px solid var(--border);padding:0.45rem 0.55rem;border-radius:6px;font-size:0.82rem;font-family:'Lora',serif;color:var(--ink);box-shadow:0 3px 6px rgba(0,0,0,0.25);pointer-events:none;white-space:pre-wrap;display:none}
  </style>
  <!-- hero‑card visuals reused from roster page -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Hero Draft</h1>

  <div id="boards">
    <div class="panel"><h2>Your Draft</h2><div id="yourDraft"  class="list"></div></div>
    <div class="panel"><h2>Enemy Draft</h2><div id="enemyDraft" class="list"></div></div>
  </div>

  <button id="ready" class="hidden">Ready for melee!</button>
  <div id="log"></div>

  <h2 style="margin:0.6rem 0 0.4rem">Your Remaining Heroes</h2>
  <div id="yourPool" class="list"></div>

<!--  ░░░  ALL LOGIC LIVES IN ONE ES‑MODULE  ░░░ -->
<script type="module">
import { supabase, PORTRAIT_BUCKET } from './supabaseClient.js';

/* ─── constants & helpers ───────────────────────── */
const ROUNDS = 5;
let playerPool=[], enemyPool=[], draftedPlayer=[], draftedEnemy=[];
let turnSide, picksMade = 0;
let abilities = {};

const $      = s => document.querySelector(s);
const cap    = s => s ? s[0].toUpperCase() + s.slice(1).toLowerCase() : '';
const log    = t => { $('#log').append(t, document.createElement('br')); $('#log').scrollTop = $('#log').scrollHeight; };
const shuffle= a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

const STAT_ABBR = {Strength:'STR',Dexterity:'DEX',Constitution:'CON',
                   Intelligence:'INT',Wisdom:'WIS',Charisma:'CHA'};

/* ─── floating tooltip element ───────────────────── */
const tip=document.createElement('div');tip.className='tooltip';document.body.append(tip);
function positionTip(e){const m=12;let x=e.clientX+m,y=e.clientY+m;
  x=Math.min(x,window.innerWidth - tip.offsetWidth - m);
  y=Math.min(y,window.innerHeight- tip.offsetHeight- m);
  tip.style.left=x+'px';tip.style.top=y+'px';
}
document.addEventListener('mousemove',e=>{if(tip.style.display!=='none')positionTip(e);});
function showTip(html,e){tip.textContent=html;tip.style.display='block';positionTip(e);}
const hideTip=()=>tip.style.display='none';

/* ─── per‑ability tooltip text ───────────────────── */
function abilityTooltip(name){
  if(!name||!abilities[name])return '';
  const ab=abilities[name];
  const out=[];
  if(ab.Description)out.push(ab.Description);
  const eff=Object.entries(ab).filter(([k,v])=>k!=='Description'&&v!==0)
    .map(([k,v])=>{
      const [stat]=k.split('_');const sign=v>0?`+${v}`:v;
      return `${sign}\u00A0${STAT_ABBR[stat]||stat}`;
    });
  if(eff.length)out.push(eff.join(', '));
  return out.join('\n');
}

/* ─── hero‑card builder ──────────────────────────── */
const portraitUrl=n=>supabase.storage.from(PORTRAIT_BUCKET)
               .getPublicUrl(`characters/${encodeURIComponent(n)}.webp`).data.publicUrl;

function makeCard(h){
  const aObj=abilities[h.Ability]||{};
  const fx=Object.entries(aObj).filter(([k,v])=>k!=='Description'&&v!==0)
      .map(([k,v])=>{const[stat]=k.split('_');const s=v>0?`+${v}`:v;return `${s}\u00A0${STAT_ABBR[stat]||stat}`;})
      .join(', ')||'—';
  const article=/^[aeiou]/i.test(h.Faction)?'An':'A';
  const el=document.createElement('div');
  el.className='hero-card';el.style.cursor='pointer';
  el.innerHTML=`
    <img src="${portraitUrl(h.Name)}" class="portrait" alt="${h.Name}" loading="lazy">
    <div class="hero-subheading" style="position:absolute;bottom:2px;left:2px;">
      HP: ${h.Health}<br>Mana: ${h.Mana}
    </div>
    <div class="bottom-info" style="margin-top:4px;">
      <div class="hero-name-banner"><span>${h.Name}</span></div>
      <div class="hero-subheading" style="margin-top:2px;">
        ${article} ${h.Faction} ${h.Class}<br>from<br>${h.Kingdom}
      </div>
      <div class="ability-block">
        <span class="ability-name">${h.Ability}:</span>
        <span class="ability-effects">${fx}</span>
      </div>
    </div>`;
  const abilEl=el.querySelector('.ability-name');
  abilEl.addEventListener('mouseenter',e=>showTip(abilityTooltip(h.Ability),e));
  abilEl.addEventListener('mouseleave',hideTip);
  return el;
}

/* ─── rendering helpers ──────────────────────────── */
function renderPlayerPool(){
  const box=$('#yourPool');box.innerHTML='';
  playerPool.forEach(h=>{
    const c=makeCard(h);
    c.onclick=()=>pickPlayer(h);
    box.append(c);
  });
}
function addToDraft(side,h){
  const box=side==='player'?$('#yourDraft'):$('#enemyDraft');
  const c=makeCard(h);c.classList.add('picked');c.onclick=null;box.append(c);
}

/* ─── pick handlers ─────────────────────────────── */
function pickPlayer(h){
  if(turnSide!=='player')return;
  draftedPlayer.push(h);playerPool=playerPool.filter(x=>x!==h);
  addToDraft('player',h);log(`You picked ${cap(h.Name)}.`);nextTurn();
}
function aiPick(){
  if(enemyPool.length===0){nextTurn();return;}
  const h=enemyPool[Math.floor(Math.random()*enemyPool.length)];
  draftedEnemy.push(h);enemyPool=enemyPool.filter(x=>x!==h);
  addToDraft('enemy',h);log(`Enemy picked ${cap(h.Name)}.`);nextTurn();
}

/* ─── turn management ───────────────────────────── */
function nextTurn(){
  picksMade++;
  if(picksMade>=ROUNDS*2){
    $('#yourPool').innerHTML='';$('#ready').classList.remove('hidden');return;
  }
  turnSide=turnSide==='player'?'enemy':'player';
  if(turnSide==='enemy')setTimeout(aiPick,700);else renderPlayerPool();
}

/* ─── READY button ──────────────────────────────── */
$('#ready').onclick=()=>{
  sessionStorage.setItem('draftPlayer',JSON.stringify(draftedPlayer));
  sessionStorage.setItem('draftEnemy', JSON.stringify(draftedEnemy));
  sessionStorage.setItem('enemy_roster',JSON.stringify(draftedEnemy));
  sessionStorage.setItem('roster',     JSON.stringify(draftedPlayer)); // battle page uses this
  window.location.href='battle.html';
};

/* ─── INITIALISATION ────────────────────────────── */
(async()=>{
  /* 1  roster & cached abilities (guaranteed present) */
  const rosterJSON=sessionStorage.getItem('roster');
  if(!rosterJSON){alert('No roster found. Go back first.');return;}
  playerPool=JSON.parse(rosterJSON);

  const abilJSON=sessionStorage.getItem('abilities');
  if(abilJSON) abilities=JSON.parse(abilJSON);

  /* 2  show your heroes immediately */
  renderPlayerPool();

  /* 3  best‑effort fetch to build enemy pool & richer tooltips */
  let allHeroes=[];
  try{
    const [hJSON,aJSON]=await Promise.all([
      fetch('heroes.json').then(r=>r.ok?r.json():Promise.reject(r)),
      fetch('abilities.json').then(r=>r.ok?r.json():Promise.reject(r))
    ]);
    allHeroes = Array.isArray(hJSON)?hJSON:Object.values(hJSON);

    if(!abilJSON){               // upgrade tooltip data if none cached
      abilities = Array.isArray(aJSON)
        ? Object.fromEntries(aJSON.map(x=>[x.Ability,x]))
        : aJSON;
      renderPlayerPool();        // refresh cards w/ descriptions
    }
  }catch(err){console.warn('Draft JSON fetch failed:',err);}

  if(allHeroes.length===0) allHeroes=playerPool;  // worst‑case fallback

  /* 4  enemy pool & kick off draft */
  enemyPool=shuffle(allHeroes.filter(h=>!playerPool.some(p=>p.Name===h.Name)))
               .slice(0,playerPool.length);

  turnSide=Math.random()<0.5?'player':'enemy';
  log(`${turnSide==='player'?'You':'Enemy'} pick first.`);
  if(turnSide==='enemy'&&enemyPool.length) setTimeout(aiPick,700);
})();
</script>
</body>
</html>
