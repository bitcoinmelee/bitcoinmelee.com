<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bitcoin¬†Melee¬†‚Äî¬†Battle¬†Arena</title>

  <!-- Fantasy fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --parchment:#f9f4e8; --ink:#2b2a29;
      --user:#216869;      --enemy:#a11d33;
      --border:#8c6b42;    --card:#fff8ef;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      padding:12vh 1rem 12vh;         /* space for roster panes */
      font-family:'Montserrat',sans-serif;
      background:var(--parchment);
      color:var(--ink);
    }
    h1{
      font-family:'Uncial Antiqua',cursive;
      font-size:2.2rem;margin:0 0 1rem;text-align:center;
    }

    /* roster panes */
    .teamPane{
      position:fixed;width:100%;left:0;z-index:15;
      background:var(--card);border:3px double var(--border);
      backdrop-filter:blur(2px);overflow-y:auto;
      padding:0.5rem 1rem;
    }
    #enemyPane{top:0;height:10vh;border-bottom-width:5px;}
    #userPane {bottom:0;height:10vh;border-top-width:5px;}

    .teamPane h2{
      margin:0 0 0.3rem;font-family:'Uncial Antiqua',cursive;font-size:1.15rem;
    }
    .teamList{
      list-style:none;margin:0;padding:0;
      display:grid;grid-template-columns:1fr 1fr;
      gap:0.35rem 0.9rem;font-size:0.78rem;
    }
    .teamList li{display:flex;flex-direction:column;line-height:1.15;}
    .rowTop{display:flex;align-items:center;gap:0.35rem;}
    .rowStats{margin-left:calc(90px + 0.35rem);}
    .rowMeta {margin-left:calc(90px + 0.35rem);font-size:0.72rem;color:#555;}
    .teamList progress{width:90px;height:8px;accent-color:var(--user);}
    #enemyPane progress{accent-color:var(--enemy);}
    #userTeam li{color:var(--user);} #enemyTeam li{color:var(--enemy);}
    .ability{font-style:italic;text-decoration:underline dotted;cursor:help;}
    .teamList strong{font-size:0.88rem;}

    /* main UI (unchanged) */
    #startBattle{
      display:block;margin:0 auto;
      padding:0.55rem 1.3rem;font-size:1.05rem;
      font-family:'Uncial Antiqua',cursive;
      background:#d1b280;border:2px solid var(--border);border-radius:6px;
    }
    #startBattle:disabled{opacity:0.5;cursor:not-allowed;}
    #battleLog{
      max-height:260px;overflow-y:auto;margin-top:1rem;
      border:2px solid var(--border);padding:0.7rem;background:#fffefa;font-size:0.9rem;
    }
    #controls{
      margin-top:1rem;border:2px solid var(--border);
      background:#fffefa;padding:0.8rem;border-radius:6px;
      box-shadow:0 1px 4px rgba(0,0,0,0.15);
    }
    #controls p{margin:0 0 0.5rem;font-family:'Uncial Antiqua',cursive;}
    .charCtrl{margin:0.45rem 0}
    .charCtrl button{
      margin-left:0.5rem;padding:0.25rem 0.6rem;border:1px solid #444;border-radius:4px;
      background:#dfd6c2;font-size:0.82rem;cursor:pointer;
    }
    .charCtrl button:hover:not(:disabled){background:#cbbfa6}
    .hidden{display:none}
    .ap{font-weight:bold}
  </style>
</head>

<body>
  <h1>Bitcoin¬†Melee</h1>

  <div id="enemyPane" class="teamPane">
    <h2>Enemy¬†Team</h2>
    <ul id="enemyTeam" class="teamList"></ul>
  </div>

  <button id="startBattle" disabled>Commence¬†Battle</button>
  <div id="battleLog"></div>
  <div id="controls" class="hidden"></div>

  <div id="userPane" class="teamPane">
    <h2>Your¬†Team</h2>
    <ul id="userTeam" class="teamList"></ul>
  </div>

<script>
/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ constants & helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const ABILITY_COST=3, ATTACK_COST=1, AP_PER_TURN=5;
const cap=s=>s? s[0].toUpperCase()+s.slice(1).toLowerCase():'';
const d20=()=>Math.floor(Math.random()*20)+1, d6=()=>Math.floor(Math.random()*6)+1;
const mod=v=>Math.floor((v-10)/2);

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ load JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
let characters=[],abilities={};
Promise.all([
  fetch('characters.json').then(r=>r.json()),
  fetch('abilities.json').then(r=>r.json())
]).then(([c,a])=>{
  characters=c;abilities=a;initTeams();startBattle.disabled=false;
}).catch(console.error);

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ team setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
let userTeamData=[],enemyTeamData=[];
function initTeams(){
  const stored=sessionStorage.getItem('roster'); if(!stored)return;
  userTeamData=JSON.parse(stored);
  const used=new Set(userTeamData.map(h=>h.Name));
  const pool=characters.filter(x=>!used.has(x.Name));
  shuffle(pool); enemyTeamData=pool.slice(0,userTeamData.length);
  renderInitialLists();
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Character class ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
class Character{
  constructor(r){
    Object.assign(this,{
      name:r.Name,maxHp:r.Health,hp:r.Health,
      str:r.Strength,dex:r.Dexterity,con:r.Constitution,
      int:r.Intelligence,wis:r.Wisdom,cha:r.Charisma,mana:r.Mana,
      ability:r['Common Ability']||'', cls:r.Class,faction:r.Faction,kingdom:r.Kingdom
    });
  }
  isAlive(){return this.hp>0;}
  attack(t){
    const atk=d20()+mod(this.str);
    if(atk<10+mod(t.dex))return{hit:false,dmg:0};
    const dmg=Math.max(1,d6()+mod(this.str));
    t.hp=Math.max(0,t.hp-dmg); return{hit:true,dmg};
  }
  _applyStat(stat,val){
    if(stat==='Health')this.hp=Math.min(this.maxHp,Math.max(0,this.hp+val));
    if(stat==='Strength')this.str=Math.max(0,this.str+val);
    if(stat==='Dexterity')this.dex=Math.max(0,this.dex+val);
    if(stat==='Constitution')this.con=Math.max(0,this.con+val);
  }
  applyAbility(allies,foes,target){
    const eff=abilities[this.ability]||{};
    for(const k in eff){
      const s=k.split('_')[0],v=eff[k];
      if(k.endsWith('_Self'))this._applyStat(s,v);
      if(k.endsWith('_ally'))allies.forEach(a=>a._applyStat(s,v));
      if(k.endsWith('_Foe')&&target)target._applyStat(s,v);
    }
  }
}
const inst=a=>a.map(r=>new Character(r));

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ diff helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function diffString(b,a){
  const map=[['hp','HP'],['str','Str'],['dex','Dex'],['con','Con']];
  const out=[];map.forEach(([k,l])=>{const d=(a[k]-b[k]);if(d!==0)out.push(`${d>0?'+':''}${d}¬†${l}`)});
  return out.join(', ');
}

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ render roster rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function hpBar(c,team){const p=document.createElement('progress');p.value=c.hp??c.Health;p.max=c.maxHp??c.Health;if(team==='enemy')p.classList.add('enemy');return p;}
function statLine(o){
  return `HP:${(o.hp??o.Health)}/${o.maxHp??o.Health}¬†`+
         `Str:${o.str??o.Strength}¬†Dex:${o.dex??o.Dexterity}¬†Con:${o.con??o.Constitution}¬†`+
         `Int:${o.int??o.Intelligence}¬†Wis:${o.wis??o.Wisdom}¬†Cha:${o.cha??o.Charisma}¬†`+
         `Mana:${o.mana??o.Mana}`;
}
function abilitySpan(name){
  const span=document.createElement('span');span.className='ability';span.textContent=cap(name);
  span.title=(abilities[name]&&abilities[name].Description)||'';return span;
}
function statsMeta(li,obj,team){
  const stats=document.createElement('div');stats.className='rowStats';stats.textContent=statLine(obj);
  li.appendChild(stats);
  const meta=document.createElement('div');meta.className='rowMeta';
  meta.appendChild(document.createTextNode(`${obj.cls||obj.Class}, ${obj.faction||obj.Faction}, ${obj.kingdom||obj.Kingdom} ‚Äî `));
  if(obj.ability||obj['Common Ability'])meta.appendChild(abilitySpan(obj.ability||obj['Common Ability']));
  li.appendChild(meta);
}
function rowFrom(rec,team,isLive){
  const li=document.createElement('li');
  const top=document.createElement('div');top.className='rowTop';
  top.appendChild(hpBar(rec,team));top.appendChild(document.createElement('strong')).textContent=` ${cap(rec.name||rec.Name)}`;
  li.appendChild(top);statsMeta(li,rec,team);if(!isLive)li.style.opacity=0.4;return li;
}
function renderInitialLists(){
  userTeam.innerHTML='';enemyTeam.innerHTML='';
  userTeamData.forEach(r=>userTeam.appendChild(rowFrom(r,'user',true)));
  enemyTeamData.forEach(r=>enemyTeam.appendChild(rowFrom(r,'enemy',true)));
}
function refreshLists(){
  userTeam.innerHTML='';enemyTeam.innerHTML='';
  playerChars.forEach(c=>userTeam.appendChild(rowFrom(c,'user',c.isAlive())));
  enemyChars.forEach(c=>enemyTeam.appendChild(rowFrom(c,'enemy',c.isAlive())));
}

/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ battle (logic unchanged except for new rowFrom & diff logging) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
let playerChars=[],enemyChars=[];let playerAP=0,aiAP=0;let usedP=new Set(),usedE=new Set();
const logDiv=document.getElementById('battleLog');function log(m){const p=document.createElement('p');p.textContent=m;logDiv.appendChild(p);logDiv.scrollTop=logDiv.scrollHeight;}

startBattle.addEventListener('click',()=>{startBattle.disabled=true;logDiv.innerHTML='';
  playerChars=inst(userTeamData);enemyChars=inst(enemyTeamData);refreshLists();playerAP=AP_PER_TURN;playerTurn=true;usedP.clear();turnPlayer();});
function turnPlayer(){if(checkVictory())return;log('‚Äî Your Turn ‚Äî');controls.classList.remove('hidden');renderCtrl();}
function renderCtrl(){
  controls.innerHTML=`<p><span class="ap">${playerAP}</span> AP</p>`;
  const avail=playerChars.filter(c=>c.isAlive()&&!usedP.has(c));
  if(!avail.length||playerAP<ATTACK_COST){endPlayer();return;}
  avail.forEach(c=>{
    const d=document.createElement('div');d.className='charCtrl';d.textContent=cap(c.name);
    if(playerAP>=ATTACK_COST){const b=document.createElement('button');b.textContent='Atk(1)';b.onclick=()=>selTarget(c,'atk');d.appendChild(b);}
    if(c.ability&&playerAP>=ABILITY_COST){const b=document.createElement('button');b.textContent=`${cap(c.ability)}(3)`;b.onclick=()=>selTarget(c,'ab');d.appendChild(b);}
    controls.appendChild(d);
  });
}
function selTarget(char,type){
  controls.innerHTML='<p>Choose target:</p>';
  const tgt=type==='atk'?enemyChars.filter(c=>c.isAlive())
        :legalTargets(char,playerChars.filter(c=>c.isAlive()),enemyChars.filter(c=>c.isAlive()));
  tgt.forEach(t=>{const b=document.createElement('button');b.textContent=cap(t.name);b.onclick=()=>actPlayer(char,type,t);controls.appendChild(b);});
}
function actPlayer(char,type,target){
  const cost=type==='atk'?ATTACK_COST:ABILITY_COST;if(playerAP<cost)return;
  if(type==='atk'){const {hit,dmg}=char.attack(target);log(hit?`${cap(char.name)} hits ${cap(target.name)} (-${dmg}¬†HP)`:`${cap(char.name)} misses ${cap(target.name)}`);}
  else{const b={hp:target.hp,str:target.str,dex:target.dex,con:target.con};char.applyAbility(playerChars,enemyChars,target);
       log(`${cap(char.name)} uses ${cap(char.ability)} on ${cap(target.name)}${(d=diffString(b,target))?' ('+d+')':''}`);}
  refreshLists();usedP.add(char);playerAP-=cost;if(checkVictory())return;playerAP>=ATTACK_COST?renderCtrl():endPlayer();}
function endPlayer(){controls.classList.add('hidden');setTimeout(turnAI,600);}

function turnAI(){if(checkVictory())return;aiAP=AP_PER_TURN;usedE.clear();log('‚Äî Enemy Turn ‚Äî');stepAI();}
function stepAI(){
  if(aiAP<ATTACK_COST){setTimeout(()=>{playerAP=AP_PER_TURN;usedP.clear();turnPlayer();},600);return;}
  const choices=enemyChars.filter(c=>c.isAlive()&&!usedE.has(c));if(!choices.length)return stepAI();
  const act=choices[Math.floor(Math.random()*choices.length)],useAb=act.ability&&aiAP>=ABILITY_COST&&Math.random()<0.25,type=useAb?'ab':'atk',cost=type==='atk'?ATTACK_COST:ABILITY_COST;
  let tgt;if(type==='atk'){const f=playerChars.filter(c=>c.isAlive());tgt=f[Math.floor(Math.random()*f.length)];const {hit,dmg}=act.attack(tgt);
    log(hit?`${cap(act.name)} hits ${cap(tgt.name)} (-${dmg}¬†HP)`:`${cap(act.name)} misses ${cap(tgt.name)}`);}
  else{const pool=legalTargets(act,enemyChars.filter(c=>c.isAlive()),playerChars.filter(c=>c.isAlive()));tgt=pool[Math.floor(Math.random()*pool.length)];
    const b={hp:tgt.hp,str:tgt.str,dex:tgt.dex,con:tgt.con};act.applyAbility(enemyChars,playerChars,tgt);
    log(`${cap(act.name)} uses ${cap(act.ability)} on ${cap(tgt.name)}${(d=diffString(b,tgt))?' ('+d+')':''}`);}
  refreshLists();usedE.add(act);aiAP-=cost;if(checkVictory())return;setTimeout(stepAI,600);}

function checkVictory(){
  const you=playerChars.some(c=>c.isAlive()),foe=enemyChars.some(c=>c.isAlive());
  if(you&&foe)return false;log(you?`üéâ You win!`:`‚ò†Ô∏è Enemy wins!`);startBattle.disabled=false;return true;
}
</script>
</body>
</html>
